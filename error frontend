<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Error Code Assistant</title>

<style>
:root {
  --bg: #f4f6f8;
  --card: #ffffff;
  --text: #222;
  --accent: #2563eb;
  --border: #ddd;
}

body.dark {
  --bg: #0f172a;
  --card: #1e293b;
  --text: #e5e7eb;
  --border: #334155;
}

body {
  margin: 0;
  background: var(--bg);
  font-family: "Segoe UI", sans-serif;
  color: var(--text);
}

.container {
  max-width: 900px;
  margin: 30px auto;
  background: var(--card);
  border-radius: 10px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.15);
  display: flex;
  flex-direction: column;
  height: 85vh;
}

.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 20px;
  border-bottom: 1px solid var(--border);
}

.header h2 {
  margin: 0;
}

.toggle {
  cursor: pointer;
  padding: 6px 12px;
  border-radius: 6px;
  background: var(--accent);
  color: white;
  border: none;
}

.chat {
  flex: 1;
  padding: 20px;
  overflow-y: auto;
}

.msg {
  margin-bottom: 15px;
}

.msg.user {
  text-align: right;
}

.msg.user .bubble {
  background: var(--accent);
  color: white;
}

.msg.bot .bubble {
  background: var(--border);
}

.bubble {
  display: inline-block;
  padding: 12px 15px;
  border-radius: 8px;
  max-width: 80%;
  white-space: pre-wrap;
}

.copy-btn {
  margin-top: 5px;
  font-size: 12px;
  cursor: pointer;
  color: var(--accent);
}

.footer {
  padding: 15px;
  border-top: 1px solid var(--border);
  display: flex;
  gap: 10px;
}

input {
  flex: 1;
  padding: 12px;
  font-size: 16px;
}

button.send {
  background: var(--accent);
  color: white;
  border: none;
  padding: 12px 18px;
  cursor: pointer;
  border-radius: 6px;
}

.history {
  padding: 10px;
  border-top: 1px solid var(--border);
  background: var(--card);
}

.history span {
  cursor: pointer;
  margin-right: 10px;
  font-size: 13px;
  color: var(--accent);
}

.suggestions {
  position: absolute;
  background: var(--card);
  border: 1px solid var(--border);
  width: calc(100% - 40px);
  max-height: 150px;
  overflow-y: auto;
  z-index: 10;
}

.suggestions div {
  padding: 8px;
  cursor: pointer;
}

.suggestions div:hover {
  background: var(--border);
}
</style>
</head>

<body>
<div class="container">
  <div class="header">
    <h2>Error Code Assistant</h2>
    <button class="toggle" onclick="toggleTheme()">ðŸŒ™ / â˜€</button>
  </div>

  <div class="chat" id="chat"></div>

  <div class="history" id="history"></div>

  <div class="footer">
    <div style="position:relative;flex:1">
      <input id="input" placeholder="Enter error code..." oninput="suggest()" onkeydown="if(event.key==='Enter')send()" />
      <div class="suggestions" id="suggestions"></div>
    </div>
    <button class="send" onclick="send()">Send</button>
  </div>
</div>

<script>
const chat = document.getElementById("chat");
const input = document.getElementById("input");
const historyDiv = document.getElementById("history");
const suggestionsDiv = document.getElementById("suggestions");

let history = JSON.parse(localStorage.getItem("history") || "[]");

function toggleTheme() {
  document.body.classList.toggle("dark");
}

function addMsg(role, text, copy=false) {
  const div = document.createElement("div");
  div.className = `msg ${role}`;
  const bubble = document.createElement("div");
  bubble.className = "bubble";
  bubble.innerHTML = text;

  div.appendChild(bubble);

  if (copy) {
    const copyBtn = document.createElement("div");
    copyBtn.className = "copy-btn";
    copyBtn.innerText = "ðŸ“‹ Copy";
    copyBtn.onclick = () => navigator.clipboard.writeText(bubble.innerText);
    div.appendChild(copyBtn);
  }

  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

function renderHistory() {
  historyDiv.innerHTML = "History: ";
  history.forEach(h => {
    const span = document.createElement("span");
    span.innerText = h;
    span.onclick = () => input.value = h;
    historyDiv.appendChild(span);
  });
}

async function send() {
  const msg = input.value.trim();
  if (!msg) return;

  addMsg("user", msg);
  input.value = "";
  suggestionsDiv.innerHTML = "";

  history = [msg, ...history.filter(h => h !== msg)].slice(0, 5);
  localStorage.setItem("history", JSON.stringify(history));
  renderHistory();

  try {
    const res = await fetch("/api/chat", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ message: msg })
    });
    const data = await res.json();
    addMsg("bot", data.response, true);
  } catch {
    addMsg("bot", "Server error");
  }
}

async function suggest() {
  const q = input.value.trim();
  if (!q) {
    suggestionsDiv.innerHTML = "";
    return;
  }

  try {
    const res = await fetch("/api/chat", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ message: q })
    });
    const data = await res.json();

    suggestionsDiv.innerHTML = "";
    if (data.type === "fuzzy_match") {
      data.data.results.forEach(r => {
        const div = document.createElement("div");
        div.innerText = r.errorcode || r.code || "Suggestion";
        div.onclick = () => {
          input.value = div.innerText;
          suggestionsDiv.innerHTML = "";
        };
        suggestionsDiv.appendChild(div);
      });
    }
  } catch {}
}

renderHistory();
</script>
</body>
</html>
